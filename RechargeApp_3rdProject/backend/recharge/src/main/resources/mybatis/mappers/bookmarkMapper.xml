<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.recharge.bookmark.dao.BookmarkDAO">

    <!-- ========================================================= -->
    <!-- 1ï¸âƒ£ ë¶ë§ˆí¬ ì¡´ìž¬ ì—¬ë¶€ -->
    <!-- ========================================================= -->
    <select id="existsBookmark" resultType="int">
        SELECT COUNT(*)
        FROM TB_BOOKMARK
        WHERE USER_ID = #{userId}
        AND BOOKMARK_TARGET_TYPE = #{bookmarkTargetType}
        AND BOOKMARK_TARGET_ID = #{bookmarkTargetId}
    </select>

    <!-- ========================================================= -->
    <!-- 2ï¸âƒ£ ì¼ë°˜ ë¶ë§ˆí¬ ë“±ë¡ (movie / music / musiclist / moviepost) -->
    <!-- ========================================================= -->
    <insert id="insertBookmark">
        <selectKey keyProperty="bookmarkId" resultType="long" order="BEFORE">
            SELECT SEQ_BOOKMARK.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO TB_BOOKMARK (
        BOOKMARK_ID,
        BOOKMARK_TARGET_TYPE,
        BOOKMARK_TARGET_ID,
        USER_ID,
        CREATE_DATE,
        CREATE_ID,
        UPDATED_DATE,
        UPDATED_ID
        ) VALUES (
        #{bookmarkId},
        #{bookmarkTargetType},
        #{bookmarkTargetId},
        #{userId},
        SYSDATE,
        #{userId},
        SYSDATE,
        #{userId}
        )
    </insert>

    <!-- ========================================================= -->
    <!-- 3ï¸âƒ£ AI ìŒì•… ë¶ë§ˆí¬ ë“±ë¡ (â­ í•µì‹¬) -->
    <!-- ========================================================= -->
    <insert id="insertAiMusicBookmark">
        <selectKey keyProperty="bookmarkId" resultType="long" order="BEFORE">
            SELECT SEQ_BOOKMARK.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO TB_BOOKMARK (
        BOOKMARK_ID,
        BOOKMARK_TARGET_TYPE,     -- music_ai
        BOOKMARK_TARGET_ID,       -- iTunes trackId
        USER_ID,

        EXT_MUSIC_TITLE,
        EXT_MUSIC_SINGER,
        EXT_MUSIC_IMAGE_PATH,

        CREATE_DATE,
        CREATE_ID,
        UPDATED_DATE,
        UPDATED_ID
        ) VALUES (
        #{bookmarkId},
        'music_ai',
        #{bookmarkTargetId},
        #{userId},

        #{extMusicTitle},
        #{extMusicSinger},
        #{extMusicImagePath},

        SYSDATE,
        #{userId},
        SYSDATE,
        #{userId}
        )
    </insert>

    <!-- ========================================================= -->
    <!-- 4ï¸âƒ£ ë¶ë§ˆí¬ ì‚­ì œ -->
    <!-- ========================================================= -->
    <delete id="deleteBookmark">
        DELETE FROM TB_BOOKMARK
        WHERE USER_ID = #{userId}
        AND BOOKMARK_TARGET_TYPE = #{bookmarkTargetType}
        AND BOOKMARK_TARGET_ID = #{bookmarkTargetId}
    </delete>

    <!-- ========================================================= -->
    <!-- 5ï¸âƒ£ ìœ ì € ë¶ë§ˆí¬ ëª©ë¡ ì¡°íšŒ (â­ í•µì‹¬) -->
    <!-- ========================================================= -->
    <select id="selectUserBookmarks"
            parameterType="string"
            resultType="com.recharge.bookmark.vo.BookmarkVO">

        SELECT
        -- ê³µí†µ
        B.BOOKMARK_ID,
        B.USER_ID                AS userId,
        B.BOOKMARK_TARGET_TYPE   AS bookmarkTargetType,
        B.BOOKMARK_TARGET_ID     AS bookmarkTargetId,

        /* ================= ðŸŽ¬ Movie ================= */
        M.MOVIE_ID               AS movieId,
        M.MOVIE_TITLE            AS title,
        M.MOVIE_POSTER           AS image,

        /* ================= ðŸŽž Movie Post ================= */
        MP.MOVIE_POST_ID         AS moviePostId,
        MP.MOVIE_POST_TITLE      AS moviePostTitle,

        /* ================= ðŸŽµ Music (ë‚´ë¶€ DB) ================= */
        MU.MUSIC_ID              AS musicId,
        MU.MUSIC_TITLE           AS musicTitle,
        MU.MUSIC_SINGER          AS musicSinger,
        MU.MUSIC_IMAGE_PATH      AS musicImagePath,

        /* ================= ðŸŽ¶ Music List ================= */
        ML.MUSIC_LIST_ID         AS musicListId,
        ML.MUSIC_TITLE           AS listMusicTitle,
        ML.MUSIC_SINGER          AS listMusicSinger,
        ML.MUSIC_IMAGE_PATH      AS listMusicImage,

        /* ================= ðŸ¤– AI Music ================= */
        B.EXT_MUSIC_TITLE        AS extMusicTitle,
        B.EXT_MUSIC_SINGER       AS extMusicSinger,
        B.EXT_MUSIC_IMAGE_PATH   AS extMusicImagePath

        FROM TB_BOOKMARK B

        /* ðŸŽ¬ movie */
        LEFT JOIN TB_MOVIE M
        ON B.BOOKMARK_TARGET_TYPE = 'movie'
        AND B.BOOKMARK_TARGET_ID = M.MOVIE_ID

        /* ðŸŽž movie post */
        LEFT JOIN TB_MOVIE_POST MP
        ON B.BOOKMARK_TARGET_TYPE = 'moviepost'
        AND B.BOOKMARK_TARGET_ID = MP.MOVIE_POST_ID

        /* ðŸŽµ music (ë‚´ë¶€ DB) */
        LEFT JOIN TB_MUSIC MU
        ON B.BOOKMARK_TARGET_TYPE = 'music'
        AND B.BOOKMARK_TARGET_ID = MU.MUSIC_ID

        /* ðŸŽ¶ music list */
        LEFT JOIN TB_MUSIC_LIST ML
        ON B.BOOKMARK_TARGET_TYPE = 'musiclist'
        AND B.BOOKMARK_TARGET_ID = ML.MUSIC_LIST_ID

        WHERE B.USER_ID = #{userId}
        ORDER BY B.CREATE_DATE DESC
    </select>

</mapper>
